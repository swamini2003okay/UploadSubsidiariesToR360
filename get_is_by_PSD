import os
from dotenv import load_dotenv
from cosmos import CosmosService
from loguru import logger

load_dotenv()

def get_parent_id_by_psd(psd_number: str) -> str:
    """
    Fetch the main parent ID from Cosmos DB using a PSD number.
    
    Args:
        psd_number (str): The PSD number to search for
        
    Returns:
        str: The main parent ID if found, None otherwise
    """
    try:
        # Initialize Cosmos service
        cosmos_service = CosmosService()
        
        # Query to find document with the given PSD number
        query = """
        SELECT c.parentId 
        FROM c 
        WHERE c.dType = @d_type 
        AND c.psdNumber = @psd_number 
        AND c.active = @is_active
        """
        
        parameters = [
            {"name": "@d_type", "value": "main_parent"},
            {"name": "@psd_number", "value": psd_number},
            {"name": "@is_active", "value": True}
        ]
        
        # Execute the query
        items = list(cosmos_service.container.query_items(
            query=query,
            parameters=parameters,
            enable_cross_partition_query=True
        ))
        
        if not items:
            logger.warning(f"No document found with PSD number: {psd_number}")
            return None
            
        # Assuming the first match is what we want
        parent_id = items[0].get('parentId')
        
        if not parent_id:
            logger.warning(f"Document found but no parentId for PSD: {psd_number}")
            return None
            
        logger.info(f"Found parent ID {parent_id} for PSD: {psd_number}")
        return parent_id
        
    except Exception as e:
        logger.error(f"Error fetching parent ID for PSD {psd_number}: {str(e)}")
        raise

if __name__ == "__main__":
    # Example usage
    psd = input("Enter PSD number: ").strip()
    if psd:
        parent_id = get_parent_id_by_psd(psd)
        if parent_id:
            print(f"Main Parent ID: {parent_id}")
        else:
            print("No matching record found for the given PSD number.")
    else:
        print("No PSD number provided.")
